<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>RTA-GUI-Components DEMO</title>

    <!-- web components -->
    <link rel="import" href="/components/light-curve.html">
    <link rel="import" href="/components/spectral-light-curve.html">

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!--
    For a Boolean property to be configurable from markup, it must default to false. If it defaults to true,
    you cannot set it to false from markup, since the presence of the attribute, with or without a value,
    equates to true. This is the standard behavior for attributes in the web platform.
    If this behavior doesn't fit your use case, you can use a string-valued or number-valued attribute instead.

    For object and array properties you can pass an object or array in JSON format:
    <my-element book='{ "title": "Persuasion", "author": "Austen" }'></my-element>
  -->

  <!-- MathJax configuration

    <script type="text/javascript">

      window.MathJax = {
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true
        }
      };
  </script>

  <script type="text/javascript" src="/bower_components/MathJax/MathJax.js?config=TeX-AMS-MML_SVG"></script>
-->


  <!--
    MathJax.Hub.Config({
      extensions: ["tex2jax.js"],
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
      },
      "HTML-CSS": { fonts: ["TeX"] }
    });
  -->



<!-- /var/www/html/spot6/cat2/js/MathJax -->




  </head>
  <body>
    <div class="container-fluid">
      <h1>RTA-GUI-Components Testpage</h1>
        <div class="container-fluid" id="startbuttons">
          <div class="btn-group btn-group-justified">
            <a href="#" id="loadData1"       class="btn btn-primary"  onclick="loadRealData('/static/light_curve.txt')">Load light_curve.txt</a>
            <a href="#" id="loadData2"       class="btn btn-primary"  onclick="loadRealData('/static/lc1_ff1gifixed_run14.txt')">Load lc1_ff1gifixed_run14.txt</a>
            <a href="#" id="startRealData"   class="btn btn-success"  onclick="startGeneratingData('real')">Start feed real data</a>
            <a href="#" id="startRandomData" class="btn btn-success"  onclick="startGeneratingData('random')">Start feed random data</a>
            <a href="#" id="resetPlot"       class="btn btn-danger"   onclick="resetPlot()">Reset plot</a>
          </div>
        </div>

        <br>
        <div class="container-fluid" id="confButtons">
          <div class="btn-group btn-group-justified">
            <a href="#" id="decrDTreal"   class="btn btn-warning"  onclick="changeDataRate(-1)">Decrease sleep between data generation</a>
            <a href="#" id="incrDTreal"   class="btn btn-warning"  onclick="changeDataRate(1)">Increase sleep between data generation</a>
            <a href="#" id="stopData"     class="btn btn-danger"   onclick="stopGeneratingData()" hidden>Stop feed data</a>
          </div>
        </div>

        <br>
        <div id="sleeptime" style="border: 2px solid green;padding: 25px;margin: 25px; text-align: center; font-size: 25px;">
          Sleep time: <p id="dt"></p>
        </div>
        <div>

        <br>
        <nav class="navbar navbar-default">
          <div class="container-fluid">
            <div class="navbar-header">
              <a class="navbar-brand" href="#">Components</a>
            </div>
            <ul class="nav navbar-nav">
              <li><a href="#" onclick="showComponent('navBarLCshow')">Light curve</a></li>
              <li><a href="#" onclick="showComponent('navBarSLCshow')">Spectral Light Curve</a></li>
              <li><a href="#" onclick="showComponent('navBarHISTshow')">Histogram</a></li>
            </ul>
          </div>
        </nav>

        <!-- LIGHT CURVE -->

        <div class="container-fluid" id="navBarLCshow">
          <h2>light-curve</h2>
            <div class="btn-group btn-group-justified">
              <a href="#" class="btn btn-success" onclick="increaseSlidingWindowSize()">Increase window size</a>
              <a href="#" class="btn btn-success" onclick="decreaseSlidingWindowSize()">Decrease window size</a>
              <a href="#" class="btn btn-warning" onclick="setMaxSlidingWindowSize()">Max window size</a>
              <a href="#" class="btn btn-warning" onclick="setMinSlidingWindowSize()">Min window size</a>
            </div>
            <div>
              Tick distance: <input type="number" value=100 id="dtickInput"/>
              <button class="btn btn-warning" onclick="setTickMode('linear')">Set tick distance</button>
              <button class="btn btn-success" onclick="setTickMode('auto')">Set tick-mode = auto</button>
            </div>
            <div>
              <button class="btn btn-primary" onclick="highlightUpperLimits()">Highlights upper limits</button>
            </div>
          <light-curve id="lightCurveWebcomp" width="1000px" height="400px" plottitle="Light Curve" xLabel="MJD [days]"  classesnumber=4 slidingwindowSize=5 debug=true></light-curve>
        </div>

        <!-- SPECTRAL LIGHT CURVE -->

        <div class="container-fluid" id="navBarSLCshow">
          <h2>spectral-light-curve</h2>
          <spectral-light-curve id="spectralLightCurveWebcomp" width="1800px" height="800px" plottitle="Spectral Light Curve" classesnumber=2 debug=true></spectral-light-curve>
        </div>



        <!-- TODO HISTOGRAM -->


    </div>





    <div style="border: 25px solid green;padding: 25px;margin: 25px;">
      Math Jax Test:
      <div>
        Static loaded math:
        <p id="mathJaxTest"></p>
      </div>
      <div>
        Dynamic loaded math:
        <p id="mathJaxAsyncTest"></p>

      </div>
      <p>
        \[
        \frac{-b\pm\sqrt{b^2-4ac}}{2a}
        \]
      </p>
    </div>

    <div style="border: 25px solid purple;padding: 25px;margin: 25px;">
      extendTraces test:
      <div id="plotyplot"></div>
      <button class="btn btn-success" onclick="extendTheTrace()">Extend the trace</button>
    </div>
    <script>
      var x_test = 0;
      function extendTheTrace() {
        var randomIntensity = generateRndIntensity();
        var rndErrors = [getRandomError(),getRandomError(),getRandomError(),getRandomError()];
        x_test = x_test + 5;

        var p = document.getElementById('plotyplot');

        Plotly.extendTraces(p, {text: [[generateRndText()]],
                                y: [[randomIntensity]],
                                x: [[x_test]],
                                'error_x.array': [[2]],
                                'error_x.arrayminus': [[3]],
                                'error_y.array': [[2]],
                                'error_y.arrayminus': [[3]]
                                } , [0])
      }
      $(document).ready(function(){

        var p = document.getElementById('plotyplot');
        var trace = {
                  type: 'scatter',
                  mode: 'markers',
                  hoverinfo: 'text',
                  text: [],
                  x: [],
                  y: [],
                  marker: {
                    size:8,
                    symbol: ['circle']
                  },
                  error_x: {
                    array: [],
                    arrayminus: [],
                    symmetric: false,
                    type: 'data',
                    visible: true,
                    width: 0,
                    thickness : 1
                  },
                  error_y: {
                    array: [],
                    arrayminus: [],
                    symmetric: false,
                    type: 'data',
                    visible: true,
                    width: 0,
                    thickness : 1
                  },
               };
          var layout = {
            showlegend: false,
            title: "test",
            xaxis: {
              title: "testX",
              showgrid: true,
              zeroline: true,
              showline: true,
              tickmode: 'auto',
              //tick0: 0,
              tickformat:"05.f",
              tickangle:0,
              titlefont: {
                family: 'Courier New, monospace',
                size: 18,
                color: '#7f7f7f'
              }
            },
            yaxis: {
              title: "testY",
              showgrid: true,
              zeroline: true,
              showline: true,
              titlefont: {
                family: 'Courier New, monospace',
                size: 18,
                color: '#7f7f7f'
              }
            },
            shapes: []
          };

          Plotly.newPlot( p , [trace], layout);


      })
    </script>





    <script>




    ////////////////////////////////////////////////////////////////////////////
    // Randomness
    var count = 0;
    function flipCoin() {
      if(Math.random()>0.5)
        return true;
      else
        return false;
    }
    function generateRndText() {
      var text = "";
      var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      for (var i = 0; i < 5; i++)
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      return text;
    }
    function generateRndIntensity() {
      var rnd = Math.floor(Math.random() * 10);
      return rnd;
    }
    function getIntensityClassForRandomData(rnd) {
      // decide class
      var pointClass;
      if(rnd <= 3)
        pointClass = 0; //2
      else if(rnd > 3 && rnd <=6)
        pointClass = 1; // 1
      else
        pointClass = 2;

      return pointClass;
    }
    function getRandomError(){
      return Math.floor(Math.random() * 3);
    }
    ////////////////////////////////////////////////////////////////////////////



    ////////////////////////////////////////////////////////////////////////////
    // Generating data
    var dataGenMode = null;

    var x_for_random;

    var realData = [];
    var index_for_real_data;
    var fluxMin = 100000;
    var fluxMax = 0;

    var interval;
    var intervalTime = 1000;

    function startGeneratingData(mode) {
      $("#startbuttons").hide();
      $("#confButtons").show();
      $("#sleeptime").show();

      if(mode == 'real')
      {
        dataGenMode = mode;
        index_for_real_data = 0;

        ////////////////////////////////////////////////
        // Application specific configurations
        document.querySelector('#lightCurveWebcomp').setYlimits(fluxMin,fluxMax);
        document.querySelector('#lightCurveWebcomp').addLine(500000,100,0,100,"rgb(50, 171, 96)",2,"dashdot");
        // document.querySelector('#lightCurveWebcomp').setTickDistance(500);


      }
      else if (mode == 'random')
      {
        dataGenMode = mode;
        x_for_random = 0;

        ////////////////////////////////////////////////
        // Application specific configurations
        document.querySelector('#lightCurveWebcomp').setYlimits(0,9);
        document.querySelector('#lightCurveWebcomp').addLine(500000,3,0,3,"rgb(50, 171, 96)",2,"dashdot");
        // document.querySelector('#lightCurveWebcomp').setTickDistance(5);
      }
      else
      {
        console.log("Error, mode??",mode);
        return;
      }
      interval = setInterval(function(){

        if( mode == 'random' )
        {
          console.log("Random data gen");

          var randomIntensity = generateRndIntensity();
          var intensityClass = getIntensityClassForRandomData(randomIntensity);
          var rndError = getRandomError();
          x_for_random = x_for_random + 5;



          document.querySelector('#lightCurveWebcomp').addPoint(
                                                        generateRndText(),
                                                        x_for_random,
                                                        randomIntensity,
                                                        rndError,
                                                        rndError,
                                                        rndError,
                                                        rndError,
                                                        flipCoin(),
                                                        intensityClass
                                                      );
        }
        else if( mode == 'real' )
        {
          console.log("New real data: ",realData[index_for_real_data] );

          if(realData.length == 0)
            console.log("Error: realData list is empty");

            document.querySelector('#lightCurveWebcomp').addPoint(
                                                          realData[index_for_real_data].text,
                                                          realData[index_for_real_data].x,
                                                          realData[index_for_real_data].y,
                                                          realData[index_for_real_data].error_x,
                                                          realData[index_for_real_data].error_x,
                                                          realData[index_for_real_data].error_y,
                                                          realData[index_for_real_data].error_y,
                                                          realData[index_for_real_data].isUpperLimit,
                                                          realData[index_for_real_data].class
                                                        );
            index_for_real_data += 1;
            if(index_for_real_data == realData.length)
              stopGeneratingData();


        }
      }, intervalTime);
    }
    function stopGeneratingData() {
      $("#startbuttons").show();
      //$("#startRandomData").show();
      $("#confButtons").hide();
      $("#sleeptime").hide();


      clearInterval(interval);
    }
    function changeDataRate(offset) {
      if(dataGenMode==null){
        console.log("Error dataGenMode=Null")
        return;
      }

      stopGeneratingData();
      if(offset<0 && intervalTime>200)
        intervalTime = intervalTime - 200;

      if(offset>0 && intervalTime<4000)
        intervalTime = intervalTime + 200;

      $('#dt').text(intervalTime+" ms");

      startGeneratingData(dataGenMode);

    }
    function resetPlot() {
      document.querySelector('#lightCurveWebcomp').resetPlot();
      dataGenMode = null;
    }
    ////////////////////////////////////////////////////////////////////////////



    ///////////////////////////////////////////////////////////////////////////
    // real data loading..
    function loadRealData(filepath) {

      console.log("Loading ",filepath);
      // parse the file
      $.get(filepath, function(result) {

          var rows = result.split("\n");
          rows.shift();
          console.log("Got real data. Number of records: ", rows.length);

          for(var i = 0; i < rows.length; i++){

            if( (rows[i].trim()).length > 0 ){


              var elements = rows[i].split(" ");
              var json_elements = {};

              // text
              json_elements["text"] = elements[6]+elements[1]+elements[2];

              // x
              json_elements["x"] = parseXValue(elements[6]);

              // y
              if(elements[0] <= 2.9)
              {
                json_elements["y"] = parseFloat(elements[11]);
                json_elements["isUpperLimit"] = true;
              }
              else
              {
                json_elements["y"] = parseFloat(elements[9]);
                json_elements["isUpperLimit"] = false;
              }

              // errors
              json_elements["error_x"] = 0.5;
              json_elements["error_y"] = parseFloat(elements[10]);

              // class
              var tsRadix = parseFloat(elements[0]);
              if(tsRadix <= 2.9)
                json_elements["class"] = 0;
              else if(tsRadix > 2.9 && tsRadix < 4)
                json_elements["class"] = 1;
              else if(tsRadix > 4 && tsRadix <= 5)
                json_elements["class"] = 2;
              else if(tsRadix > 5)
                json_elements["class"] = 3;
              else
                console.log("Error. cant assign class. sqrtts : ",elements[0]);

              realData.push(json_elements);
            }
            else
            {
              console.log("Empty row found!");
            }
          }

          // find min and max flux:
          for(var i = 0; i < realData.length; i++){
            if(realData[i]["y"] > fluxMax) {
              fluxMax = realData[i]["y"];
            }
            if(realData[i]["y"] < fluxMin) {
              fluxMin = realData[i]["y"];
            }
          }
          console.log("flux max and min:", fluxMax, fluxMin)

          $("#startRealData").show();

      });
    }
    function parseXValue(xString){
      var times = xString.split("/");
      return (parseFloat(times[0])+parseFloat(times[1]))/2;
    }



    ///////////////////////////////////////////////////////////////////////////
    // Navigation Bar
    var navbarButtons = ["navBarLCshow","navBarSLCshow","navBarHISTshow"];
    function showComponent(compId) {
      navbarButtons.forEach(function(cId, index){
        if(cId==compId)
          $("#"+cId).show();
        else
          $("#"+cId).hide();
      })
    }


    /////////////////////////////////////////////////////////////////////////////
    // ON READY

    $('document').ready(function() {


      $("#startRealData").hide();

      $("#confButtons").hide();

      $("#sleeptime").hide();

      showComponent("navBarLCshow");

      ////////////////////////////////////////////////
      // General configurations
      document.querySelector('#lightCurveWebcomp').setPlotTitle("Light curve");
      document.querySelector('#lightCurveWebcomp').setAxisLalbes("MJD [days]", "$\\text{ [10}^{-8}\\text{ph }\\text{cm}^{-2}\\text{ s}^{-1}\\text{]}$");

      document.querySelector('#spectralLightCurveWebcomp').setPlotTitle("Spectral Light curve");
      document.querySelector('#spectralLightCurveWebcomp').setAxisLalbes("Energy [MeV]","$\\text{erg}\\text{cm}^{-2}\\text{s}^{-1}$");

      document.querySelector('#spectralLightCurveWebcomp').setAxisTickText(
                                                                    [ "$10^{1}$","","","","","","","","",
                                                                      "$10^{2}$","","","","","","","","",
                                                                      "$10^{3}$","","","","","","","","",
                                                                      "$10^{4}$","","","","",""],
                                                                    [ "$10^{-13}$","","","","","","","","",
                                                                      "$10^{-12}$","","","","","","","","",
                                                                      "$10^{-11}$","","","","","","","","",
                                                                      "$10^{-10}$","","","","","","","","",
                                                                      "$10^{-9}$","","","","","","","","",
                                                                      "$10^{-8}$","","","","","","","","",
                                                                      "$10^{-7}$","","","","","","","","",
                                                                      "$10^{-6}$","","","","","","","","",
                                                                      "$10^{-5}$","","","","","","","",""]);

      $('#dt').text(" 1000 ms");
      $('#dt').css("font-size", "16px"); // to fix




      $('#mathJaxTest').text("$10^{-13}$");

      // use setTimeout() to execute
      setTimeout(function(){
        $('#mathJaxAsyncTest').text("$5^{-15}$");
        MathJax.Hub.Queue(["Typeset",MathJax.Hub,"mathJaxAsyncTest"]);
      }, 2000)



    });






    ///////////////////////////////////////////////////////////////////////////
    // light-curve API
    function increaseSlidingWindowSize() {
      document.querySelector('#lightCurveWebcomp').increaseSlidingWindowSize();
    }
    function decreaseSlidingWindowSize() {
      document.querySelector('#lightCurveWebcomp').decreaseSlidingWindowSize();
    }
    function setMaxSlidingWindowSize() {
      document.querySelector('#lightCurveWebcomp').setMaxSlidingWindowSize();
    }
    function setMinSlidingWindowSize() {
      document.querySelector('#lightCurveWebcomp').setMinSlidingWindowSize();
    }
    function setTickMode(mode) {
      if (mode=='linear')
      {
        var tickDistance = $('#dtickInput').val();
        document.querySelector('#lightCurveWebcomp').setTickDistance(tickDistance);
      }
      else if (mode=='auto')
      {
        document.querySelector('#lightCurveWebcomp').setTickAutoMode();
      }
    }
    function highlightUpperLimits() {
      document.querySelector('#lightCurveWebcomp').highlightUpperLimits();
    }
    ////////////////////////////////////////////////////////////////////////////
    </script>
  </body>
</html>
